#!/bin/bash
set -euo pipefail

CONFIG_DIR="${SAFE_RM_CONFIG_DIR:-${XDG_CONFIG_HOME:-$HOME/.config}/safe-rm}"
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/safe-rm"
AUDIT_LOG="${SAFE_RM_AUDIT_LOG:-$STATE_DIR/audit.log}"
REAL_RM="/usr/bin/rm"

mkdir -p "$(dirname "$AUDIT_LOG")"
touch "$AUDIT_LOG" 2>/dev/null || true

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

if ! command -v trash-put >/dev/null 2>&1; then
    echo -e "${RED}ERROR: trash-cli is not installed${NC}" >&2
    echo "Install with: sudo zypper install trash-cli" >&2
    exit 1
fi

log_operation() {
    local classification="$1"
    local path="$2"
    local action="$3"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "$timestamp | $classification | $path | $action" >> "$AUDIT_LOG" 2>/dev/null || true
}

is_in_git_repo() {
    git rev-parse --is-inside-work-tree >/dev/null 2>&1
}

is_untracked() {
    local file="$1"
    if is_in_git_repo; then
        git ls-files --others --exclude-standard | grep -Fxq "$file" 2>/dev/null
    else
        return 1
    fi
}

is_ignored() {
    local file="$1"
    if is_in_git_repo; then
        git check-ignore -q "$file" 2>/dev/null
    else
        return 1
    fi
}

is_source_code() {
    local file="$1"
    case "${file##*.}" in
        py|js|ts|jsx|tsx|rs|go|java|c|cpp|h|hpp|rb|php|sh|bash|zsh|md|txt|rst|adoc)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

is_recently_modified() {
    local file="$1"
    if [[ -f "$file" ]]; then
        local file_time current_time age
        file_time=$(stat -c %Y "$file" 2>/dev/null || stat -f %m "$file" 2>/dev/null)
        current_time=$(date +%s)
        age=$((current_time - file_time))
        [[ $age -lt 86400 ]]
    else
        return 1
    fi
}

classify_file() {
    local file="$1"
    local basename
    basename=$(basename "$file")

    case "$file" in
        .git|.git/*|/|/home|/etc|/usr|/var|/bin|/sbin|/lib|/lib64)
            echo "BLOCK"
            return
            ;;
    esac

    case "$basename" in
        *important*|*backup*|*IMPORTANT*|*BACKUP*)
            echo "BLOCK"
            return
            ;;
    esac

    case "$basename" in
        node_modules|dist|build|target|out|.next|public_build|__pycache__|.pytest_cache|.mypy_cache|.tox|.cache|vendor|.venv|venv|env)
            echo "ALLOW"
            return
            ;;
    esac

    case "$file" in
        *.pyc|*.pyo|*.class|*.o|*.so|*.dll|*.dylib|*.tmp|*.temp|*.log|*.swp|*.swo|*~|.DS_Store|Thumbs.db)
            echo "ALLOW"
            return
            ;;
    esac

    if is_ignored "$file"; then
        echo "ALLOW"
        return
    fi

    if is_untracked "$file" && is_source_code "$file"; then
        echo "TRASH"
        return
    fi

    if is_recently_modified "$file"; then
        echo "TRASH"
        return
    fi

    if is_untracked "$file"; then
        case "${file##*.}" in
            json|yaml|yml|toml|ini|conf|config|env)
                echo "TRASH"
                return
                ;;
        esac
    fi

    echo "TRASH"
}

delete_file() {
    local file="$1"
    local force="$2"
    local abs_path classification
    abs_path=$(readlink -f "$file" 2>/dev/null || echo "$file")
    classification=$(classify_file "$abs_path")
    
    case "$classification" in
        BLOCK)
            echo -e "${RED}BLOCKED:${NC} Refusing to delete protected path: $file" >&2
            log_operation "BLOCK" "$abs_path" "REFUSED"
            return 1
            ;;
            
        ALLOW)
            if [[ "$force" == "true" ]]; then
                "$REAL_RM" -rf "$file"
                echo -e "${GREEN}DELETED:${NC} $file (build artifact)"
                log_operation "ALLOW" "$abs_path" "deleted"
            else
                echo -e "${BLUE}→ WOULD DELETE:${NC} $file (build artifact)"
                log_operation "ALLOW" "$abs_path" "dry-run"
            fi
            ;;
            
        TRASH)
            if [[ "$force" == "true" ]]; then
                trash-put "$file"
                echo -e "${YELLOW}TRASHED:${NC} $file (recoverable)"
                log_operation "TRASH" "$abs_path" "trashed"
            else
                echo -e "${BLUE}→ WOULD TRASH:${NC} $file (recoverable)"
                log_operation "TRASH" "$abs_path" "dry-run"
            fi
            ;;
    esac
}

# Main execution
main() {
    local force=false
    local recursive=false
    local files=()
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force)
                force=true
                shift
                ;;
            -r|-R|--recursive)
                recursive=true
                shift
                ;;
            -rf|-fr)
                force=true
                recursive=true
                shift
                ;;
            -n|--dry-run)
                force=false
                shift
                ;;
            --real-rm)
                shift
                echo -e "${RED}WARNING: Using real rm (bypassing protection, logged)${NC}" >&2
                log_operation "BYPASS" "$*" "real-rm-used"
                exec "$REAL_RM" "$@"
                ;;
            --help|-h)
                cat << 'EOF'
safe-rm: Protected file deletion wrapper

Usage: rm [OPTIONS] FILE...

Options:
  -f, --force       Force deletion (execute, not dry-run)
  -r, -R            Recursive deletion
  -n, --dry-run     Show what would be deleted without deleting
  --real-rm         Bypass protection (use actual rm - logged)
  -h, --help        Show this help message

Classification:
  ALLOW  - Build artifacts, dependencies, temp files (deleted directly)
  TRASH  - Source code, configs, recent files (moved to trash)
  BLOCK  - .git, system paths, protected files (refused)

Recovery:
  trash-list        - View trashed files
  trash-restore     - Restore trashed files
  rm-log / tail \$SAFE_RM_AUDIT_LOG - View deletion log (default: ~/.local/state/safe-rm/audit.log)

Examples:
  rm -rf node_modules/     # Deletes directly (build artifact)
  rm -rf src/draft.py      # Moves to trash (untracked source)
  rm -rf .git/             # Blocked (protected)

EOF
                exit 0
                ;;
            -*)
                echo -e "${YELLOW}Warning: Unknown option $1 (ignored)${NC}" >&2
                shift
                ;;
            *)
                files+=("$1")
                shift
                ;;
        esac
    done

    if [[ ${#files[@]} -eq 0 ]]; then
        echo -e "${RED}ERROR: No files specified${NC}" >&2
        echo "Use 'rm --help' for usage information" >&2
        exit 1
    fi

    if [[ "$force" != "true" ]]; then
        echo -e "${BLUE}DRY RUN MODE:${NC} Use -f to execute deletions"
        echo ""
    fi

    local exit_code=0
    for file in "${files[@]}"; do
        if [[ ! -e "$file" ]]; then
            echo -e "${YELLOW}Warning:${NC} $file does not exist" >&2
            continue
        fi
        
        if [[ -d "$file" ]]; then
            if [[ "$recursive" == "true" ]]; then
                delete_file "$file" "$force" || exit_code=1
            else
                echo -e "${RED}ERROR:${NC} $file is a directory (use -r for recursive)" >&2
                exit_code=1
            fi
        else
            delete_file "$file" "$force" || exit_code=1
        fi
    done

    if [[ "$force" != "true" ]]; then
        echo ""
        echo -e "${BLUE}To execute these operations, run with -f flag${NC}"
        echo -e "View audit log: ${BLUE}rm-log${NC} or ${BLUE}tail \$SAFE_RM_AUDIT_LOG${NC}"
    fi
    
    exit $exit_code
}

main "$@"
