name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck
      
      - name: Lint shell scripts
        run: |
          shellcheck bin/safe-rm
          shellcheck safe-rm.plugin.zsh
          shellcheck install.sh

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v3
      
      - name: Install zsh
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y zsh trash-cli
          else
            brew install zsh trash-cli
          fi
      
      - name: Run installation
        shell: zsh {0}
        run: |
          ./install.sh
      
      - name: Test basic functionality
        shell: zsh {0}
        run: |
          source "${GITHUB_WORKSPACE}/safe-rm.plugin.zsh"
          mkdir test-dir
          cd test-dir
          git init
          echo "test" > file.txt
          rm -n file.txt
          rm -f file.txt
          trash-list | grep -q file.txt || (trash-list; exit 1)
      
      - name: Verify status command
        shell: zsh {0}
        run: |
          source "${GITHUB_WORKSPACE}/safe-rm.plugin.zsh"
          safe-rm-status

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check markdown links
        uses: tcort/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
